The Benchmark library provides a number of functions whose primary purpose in to affect assembly generation, including {\ttfamily Do\+Not\+Optimize} and {\ttfamily Clobber\+Memory}. In addition there are other functions, such as {\ttfamily Keep\+Running}, for which generating good assembly is paramount.

For these functions it\textquotesingle{}s important to have tests that verify the correctness and quality of the implementation. This requires testing the code generated by the compiler.

This document describes how the Benchmark library tests compiler output, as well as how to properly write new tests.\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md4}{}\doxysection{Anatomy of a Test}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md4}
Writing a test has two steps\+:


\begin{DoxyItemize}
\item Write the code you want to generate assembly for.
\item Add {\ttfamily // C\+H\+E\+CK} lines to match against the verified assembly.
\end{DoxyItemize}

Example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{ \{c++\}}
\DoxyCodeLine{}
\DoxyCodeLine{// CHECK-\/LABEL: test\_add:}
\DoxyCodeLine{extern "C" int test\_add() \{}
\DoxyCodeLine{    extern int ExternInt;}
\DoxyCodeLine{    return ExternInt + 1;}
\DoxyCodeLine{}
\DoxyCodeLine{    // CHECK: movl ExternInt(\%rip), \%eax}
\DoxyCodeLine{    // CHECK: addl \%eax}
\DoxyCodeLine{    // CHECK: ret}
\DoxyCodeLine{\}}
\end{DoxyCode}
\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md5}{}\doxysubsubsection{L\+L\+V\+M Filecheck}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md5}
\href{https://llvm.org/docs/CommandGuide/FileCheck.html}{\texttt{ L\+L\+VM\textquotesingle{}s Filecheck}} is used to test the generated assembly against the {\ttfamily // C\+H\+E\+CK} lines specified in the tests source file. Please see the documentation linked above for information on how to write {\ttfamily C\+H\+E\+CK} directives.\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md6}{}\doxysubsubsection{Tips and Tricks\+:}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md6}

\begin{DoxyItemize}
\item Tests should match the minimal amount of output required to establish correctness. {\ttfamily C\+H\+E\+CK} directives don\textquotesingle{}t have to match on the exact next line after the previous match, so tests should omit checks for unimportant bits of assembly. (\href{https://llvm.org/docs/CommandGuide/FileCheck.html\#the-check-next-directive}{\texttt{ {\ttfamily C\+H\+E\+C\+K-\/\+N\+E\+XT}}} can be used to ensure a match occurs exactly after the previous match).
\item The tests are compiled with {\ttfamily -\/O3 -\/g0}. So we\textquotesingle{}re only testing the optimized output.
\item The assembly output is further cleaned up using {\ttfamily tools/strip\+\_\+asm.\+py}. This removes comments, assembler directives, and unused labels before the test is run.
\item The generated and stripped assembly file for a test is output under {\ttfamily $<$build-\/directory$>$/test/$<$test-\/name$>$.s}
\item Filecheck supports using \href{https://llvm.org/docs/CommandGuide/FileCheck.html\#cmdoption-check-prefixes}{\texttt{ {\ttfamily C\+H\+E\+CK} prefixes}} to specify lines that should only match in certain situations. The Benchmark tests use {\ttfamily C\+H\+E\+C\+K-\/\+C\+L\+A\+NG} and {\ttfamily C\+H\+E\+C\+K-\/\+G\+NU} for lines that are only expected to match Clang or G\+CC\textquotesingle{}s output respectively. Normal {\ttfamily C\+H\+E\+CK} lines match against all compilers. (Note\+: {\ttfamily C\+H\+E\+C\+K-\/\+N\+OT} and {\ttfamily C\+H\+E\+C\+K-\/\+L\+A\+B\+EL} are N\+OT prefixes. They are versions of non-\/prefixed {\ttfamily C\+H\+E\+CK} lines)
\item Use {\ttfamily extern \char`\"{}\+C\char`\"{}} to disable name mangling for specific functions. This makes them easier to name in the {\ttfamily C\+H\+E\+CK} lines.
\end{DoxyItemize}\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md7}{}\doxysection{Problems Writing Portable Tests}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md7}
Writing tests which check the code generated by a compiler are inherently non-\/portable. Different compilers and even different compiler versions may generate entirely different code. The Benchmark tests must tolerate this.

L\+L\+VM Filecheck provides a number of mechanisms to help write \char`\"{}more portable\char`\"{} tests; including \href{https://llvm.org/docs/CommandGuide/FileCheck.html\#filecheck-pattern-matching-syntax}{\texttt{ matching using regular expressions}}, allowing the creation of \href{https://llvm.org/docs/CommandGuide/FileCheck.html\#filecheck-variables}{\texttt{ named variables}} for later matching, and \href{https://llvm.org/docs/CommandGuide/FileCheck.html\#the-check-dag-directive}{\texttt{ checking non-\/sequential matches}}.\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md8}{}\doxysubsubsection{Capturing Variables}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md8}
For example, say G\+CC stores a variable in a register but Clang stores it in memory. To write a test that tolerates both cases we \char`\"{}capture\char`\"{} the destination of the store, and then use the captured expression to write the remainder of the test.


\begin{DoxyCode}{0}
\DoxyCodeLine{ \{c++\}}
\DoxyCodeLine{// CHECK-\/LABEL: test\_div\_no\_op\_into\_shr:}
\DoxyCodeLine{extern "C" void test\_div\_no\_op\_into\_shr(int value) \{}
\DoxyCodeLine{    int divisor = 2;}
\DoxyCodeLine{    benchmark::DoNotOptimize(divisor); // hide the value from the optimizer}
\DoxyCodeLine{    return value / divisor;}
\DoxyCodeLine{}
\DoxyCodeLine{    // CHECK: movl \$2, [[DEST:.*]]}
\DoxyCodeLine{    // CHECK: idivl [[DEST]]}
\DoxyCodeLine{    // CHECK: ret}
\DoxyCodeLine{\}}
\end{DoxyCode}
\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md9}{}\doxysubsubsection{Using Regular Expressions to Match Differing Output}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md9}
Often tests require testing assembly lines which may subtly differ between compilers or compiler versions. A common example of this is matching stack frame addresses. In this case regular expressions can be used to match the differing bits of output. For example\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{ \{c++\}}
\DoxyCodeLine{int ExternInt;}
\DoxyCodeLine{struct Point \{ int x, y, z; \};}
\DoxyCodeLine{}
\DoxyCodeLine{// CHECK-\/LABEL: test\_store\_point:}
\DoxyCodeLine{extern "C" void test\_store\_point() \{}
\DoxyCodeLine{    Point p\{ExternInt, ExternInt, ExternInt\};}
\DoxyCodeLine{    benchmark::DoNotOptimize(p);}
\DoxyCodeLine{}
\DoxyCodeLine{    // CHECK: movl ExternInt(\%rip), \%eax}
\DoxyCodeLine{    // CHECK: movl \%eax, -\/\{\{[0-\/9]+\}\}(\%rsp)}
\DoxyCodeLine{    // CHECK: movl \%eax, -\/\{\{[0-\/9]+\}\}(\%rsp)}
\DoxyCodeLine{    // CHECK: movl \%eax, -\/\{\{[0-\/9]+\}\}(\%rsp)}
\DoxyCodeLine{    // CHECK: ret}
\DoxyCodeLine{\}}
\end{DoxyCode}
\hypertarget{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md10}{}\doxysection{Current Requirements and Limitations}\label{md__home_mary_VegaProgramEngineering_2024_build__deps_googlebenchmark-src_docs_AssemblyTests_autotoc_md10}
The tests require Filecheck to be installed along the {\ttfamily P\+A\+TH} of the build machine. Otherwise the tests will be disabled.

Additionally, as mentioned in the previous section, codegen tests are inherently non-\/portable. Currently the tests are limited to\+:


\begin{DoxyItemize}
\item x86\+\_\+64 targets.
\item Compiled with G\+CC or Clang
\end{DoxyItemize}

Further work could be done, at least on a limited basis, to extend the tests to other architectures and compilers (using {\ttfamily C\+H\+E\+CK} prefixes).

Furthermore, the tests fail for builds which specify additional flags that modify code generation, including {\ttfamily -\/-\/coverage} or {\ttfamily -\/fsanitize=}. 